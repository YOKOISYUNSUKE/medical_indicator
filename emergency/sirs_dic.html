<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SOFA / qSOFA | 医療電算機</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 共通CSS（分割後） -->
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/responsive.css" />

  <!-- 共通ヘッダー/フッター読込 -->
  <script src="../js/include.js" defer></script>
  <!-- 共通スコアユーティリティ -->
  <script src="../js/score-utils.js" defer></script>
  <!-- このスコア専用の計算JSがあればここに -->
</head>

<!-- data-subtitle に、このページ固有のサブタイトルを書く -->
<body data-subtitle="SOFA / qSOFA スコア計算">
  <!-- 共通ヘッダー -->
  <div data-include="../partials/header.html"></div>

  <main>
    <div class="wrapper">
      <div class="score-card-container">
        <a href="emergency.index.html" class="back-link">← 救急スコア一覧に戻る</a>

        <div class="score-title">SIRS / 急性期DIC（JAAM, 厚労省ルート）</div>
        <div class="score-subtitle">
          上部で SIRS に関するバイタルと、DIC に必要な検査値を入力すると、SIRS スコアと急性期DICスコアを同時に算出します。
        </div>

        <!-- 入力フォーム -->
        <form id="sirs_dic_form" onsubmit="return false;">

          <div class="section-label">SIRS 判定用バイタル</div>
          <div class="form-grid">
            <div class="form-row">
              <label for="temp">体温 (℃)</label>
              <input id="temp" type="number" step="0.1" />
            </div>
            <div class="form-row">
              <label for="hr">心拍数 (/分)</label>
              <input id="hr" type="number" min="0" />
            </div>
            <div class="form-row">
              <label for="rr">呼吸数 (/分)</label>
              <input id="rr" type="number" min="0" />
            </div>
            <div class="form-row">
              <label for="paco2">PaCO₂ (mmHg)</label>
              <input id="paco2" type="number" min="0" />
            </div>
            <div class="form-row">
              <label for="wbc">白血球数 (/μL)</label>
              <input id="wbc" type="number" min="0" />
            </div>
            <div class="form-row">
              <label for="bands">幼若球比 (%)</label>
              <input id="bands" type="number" min="0" max="100" step="0.1" />
            </div>
          </div>

          <div class="small-note">
            SIRS 条件：<br />
            ・体温 &gt; 38℃ または &lt; 36℃<br />
            ・心拍数 &gt; 90 /分<br />
            ・呼吸数 &gt; 20 /分 または PaCO₂ &lt; 32 mmHg<br />
            ・白血球数 &gt; 12,000 /μL または &lt; 4,000 /μL または 幼若球比 &gt; 10%<br />
            ※ 2項目以上で SIRS とされます。
          </div>

          <div class="section-label">DIC 判定用検査値（急性期DIC診断基準）</div>
          <div class="form-grid">
            <div class="form-row">
              <label for="plt">血小板数 (/μL)</label>
              <input id="plt" type="number" min="0" />
            </div>
            <div class="form-row">
              <label for="plt_drop">血小板減少率 (24時間, %)</label>
              <input id="plt_drop" type="number" min="0" max="100" step="0.1" />
            </div>
            <div class="form-row">
              <label for="pt_ratio">PT比 (検体PT秒 / 正常対照)</label>
              <input id="pt_ratio" type="number" min="0" step="0.01" />
            </div>
            <div class="form-row">
              <label for="fdp">FDP (μg/mL)</label>
              <input id="fdp" type="number" min="0" step="0.1" />
            </div>
          </div>

          <div class="small-note">
            急性期DIC 診断基準（日本救急医学会）：<br />
            ・項目：SIRS スコア、血小板数/減少率、PT比、FDP<br />
            ・スコア ≥ 4 点で「急性期 DIC」と診断されます。<br />
            ※ Dダイマーしかない場合は各施設の換算表等を用いて FDP 相当値を入力してください。
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-primary" onclick="calculateSIRSandDIC()">
              SIRS / DIC計算
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearAll()">
              クリア
            </button>
          </div>
        </form>

        <!-- 結果表示 -->
        <div class="result-area">
          <div class="result-card" id="card_sirs">
            <div class="result-title">SIRS スコア</div>
            <div class="result-value">--</div>
            <div class="result-category"></div>
            <div class="result-message">
              4項目のうち、条件を満たす項目数を表示します（2項目以上でSIRS）。
            </div>
          </div>

          <div class="result-card" id="card_dic">
            <div class="result-title">急性期DICスコア</div>
            <div class="result-value">--</div>
            <div class="result-category"></div>
            <div class="result-message">
              SIRS、血小板、PT比、FDP から算出される急性期DICスコアです（4点以上でDIC）。
            </div>
          </div>
        </div>

        <div class="result-warning">
          ※ 本ツールは急性期DIC診断基準（JAAM）を参考に作成しています。<br />
          ※ 計算結果は参考値であり、診断・治療方針は必ず臨床医の総合判断で行ってください。
        </div>
      </div>
    </div>
  </main>

  <footer>
    © 医療電算機 v0.1
  </footer>

  <script>
    function getNumberOrNaN(id) {
      const el = document.getElementById(id);
      if (!el) return NaN;
      const v = el.value.trim();
      if (v === "") return NaN;
      return Number(v);
    }

    function setResult(cardId, value, categoryText, extraMessage) {
      const card = document.getElementById(cardId);
      if (!card) return;
      const v = card.querySelector(".result-value");
      const c = card.querySelector(".result-category");
      const m = card.querySelector(".result-message");

      if (value == null) {
        if (v) v.textContent = "--";
      } else if (v) {
        v.textContent = value;
      }
      if (c) c.textContent = categoryText || "";
      if (m && extraMessage) m.textContent = extraMessage;
    }

    function calculateSIRSandDIC() {
      // --- SIRS ---
      const temp = getNumberOrNaN("temp");
      const hr = getNumberOrNaN("hr");
      const rr = getNumberOrNaN("rr");
      const paco2 = getNumberOrNaN("paco2");
      const wbc = getNumberOrNaN("wbc");
      const bands = getNumberOrNaN("bands");

      let sirsScore = 0;
      let hasAnySirsInput = false;

      if (!isNaN(temp)) {
        hasAnySirsInput = true;
        if (temp > 38 || temp < 36) sirsScore++;
      }
      if (!isNaN(hr)) {
        hasAnySirsInput = true;
        if (hr > 90) sirsScore++;
      }
      if (!isNaN(rr) || !isNaN(paco2)) {
        hasAnySirsInput = true;
        if ((!isNaN(rr) && rr > 20) || (!isNaN(paco2) && paco2 < 32)) sirsScore++;
      }
      if (!isNaN(wbc) || !isNaN(bands)) {
        hasAnySirsInput = true;
        if (
          (!isNaN(wbc) && (wbc > 12000 || wbc < 4000)) ||
          (!isNaN(bands) && bands > 10)
        ) {
          sirsScore++;
        }
      }

      if (!hasAnySirsInput) {
        setResult(
          "card_sirs",
          null,
          "",
          "SIRS の計算に必要な値が入力されていません。"
        );
      } else {
        const sirsCategory =
          sirsScore >= 2 ? "SIRS 基準を満たす可能性あり（2項目以上）" : "SIRS 基準未満（参考値）";
        const sirsMsg =
          "欠測項目は 0 点として扱っています。臨床像とあわせて解釈してください。";
        setResult(
          "card_sirs",
          sirsScore.toString(),
          sirsCategory,
          sirsMsg
        );
      }

      // --- 急性期DICスコア ---
      const plt = getNumberOrNaN("plt");
      const pltDrop = getNumberOrNaN("plt_drop");
      const ptRatio = getNumberOrNaN("pt_ratio");
      const fdp = getNumberOrNaN("fdp");

      let validForDIC = true;
      let missingReasons = [];

      if (!hasAnySirsInput) {
        validForDIC = false;
        missingReasons.push("SIRS スコア");
      }
      if (isNaN(plt) && isNaN(pltDrop)) {
        validForDIC = false;
        missingReasons.push("血小板数または減少率");
      }
      if (isNaN(ptRatio)) {
        validForDIC = false;
        missingReasons.push("PT比");
      }
      if (isNaN(fdp)) {
        validForDIC = false;
        missingReasons.push("FDP");
      }

      if (!validForDIC) {
        setResult(
          "card_dic",
          null,
          "",
          "急性期DICスコアの算出に必要な項目が不足しています：" +
            missingReasons.join("、")
        );
        return;
      }

      // SIRSによる DIC スコア（0 or 1）
      const dicSirsScore = sirsScore >= 3 ? 1 : 0;

      // 血小板スコア
      let pltScore = 0;
      if (
        (!isNaN(plt) && plt < 80000) ||
        (!isNaN(pltDrop) && pltDrop >= 50)
      ) {
        pltScore = 3;
      } else if (
        (!isNaN(plt) && plt < 120000) ||
        (!isNaN(pltDrop) && pltDrop >= 30)
      ) {
        pltScore = 1;
      }

      // PT比スコア
      let ptScore = 0;
      if (ptRatio >= 1.2) ptScore = 1;

      // FDPスコア
      let fdpScore = 0;
      if (fdp >= 25) fdpScore = 3;
      else if (fdp >= 10) fdpScore = 1;

      const total = dicSirsScore + pltScore + ptScore + fdpScore;

      let category = "";
      let msg = "";

      if (total >= 4) {
        category = "急性期DIC（4点以上）";
        msg = "急性期DIC診断基準で DIC と診断されるスコアです。基礎疾患や出血傾向を含めて早期治療介入を検討してください。";
      } else {
        category = "DIC 基準未満（0–3点）";
        msg = "現時点では急性期DIC 診断基準のカットオフ（4点）未満です。経時的な推移に注意してください。";
      }

      setResult(
        "card_dic",
        total.toString(),
        `スコア：${category}`,
        msg
      );
    }

    function clearAll() {
      const form = document.getElementById("sirs_dic_form");
      if (form) form.reset();

      setResult(
        "card_sirs",
        null,
        "",
        "4項目のうち、条件を満たす項目数を表示します（2項目以上でSIRS）。"
      );
      setResult(
        "card_dic",
        null,
        "",
        "SIRS、血小板、PT比、FDP から算出される急性期DICスコアです（4点以上でDIC）。"
      );
    }
  </script>
  <!-- 共通フッター -->
  <div data-include="../partials/footer.html"></div>
</body>
</html>
